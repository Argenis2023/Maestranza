{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Inventario de Productos</title>
    <link rel="stylesheet" href="{% static 'productos/styles.css' %}">
</head>
<body>
    <div class="container">
        <h1>Inventario de Productos</h1>

        <!-- Buscador -->
        <form method="get" action="." style="text-align:right; margin-bottom:14px;">
            <input type="text" name="q" value="{{ q }}" placeholder="Buscar por nombre, serie, ubicaci√≥n o proveedor" style="padding:6px; border-radius:5px; border:1px solid #ddd; width: 300px;">
            <button type="submit" style="padding:6px 14px; border:none; border-radius:5px; background:#1976d2; color:white;">Buscar</button>
            {% if q %}
                <a href="." style="margin-left:12px; color:#1976d2;">Limpiar</a>
            {% endif %}
        </form>

        <!-- Productos en stock cr√≠tico -->
        <div class="productos-criticos">
            <h3 style="color:#e74c3c; margin-top:0;">Productos en stock cr√≠tico</h3>
            {% if productos_criticos %}
                {% for producto in productos_criticos %}
                    <div class="producto-critico">
                        {{ producto.nombre }} (Stock: {{ producto.stock }} / M√≠nimo: {{ producto.stock_minimo }})
                    </div>
                {% endfor %}
            {% else %}
                <span style="color: #2ecc71;">No hay productos cr√≠ticos üëè</span>
            {% endif %}
        </div>

        <!-- Listado de productos -->
        {% for producto in productos %}
        <div class="producto">
            {% if producto.imagen_url %}
                <img src="{{ producto.imagen_url }}" alt="{{ producto.nombre }}">
            {% else %}
                <img src="https://via.placeholder.com/120x120?text=Sin+Imagen" alt="Sin Imagen">
            {% endif %}
            <div>
                <strong>{{ producto.nombre }}</strong>
                <!-- Botones de editar y eliminar -->
                <a href="{% url 'editar_producto' producto.pk %}" style="color:#1976d2; margin-left:12px; font-size:14px;">Editar</a>
                <a href="{% url 'eliminar_producto' producto.pk %}" style="color:#e74c3c; margin-left:8px; font-size:14px;">Eliminar</a>
                <br>
                <span>{{ producto.descripcion }}</span><br>
                <small>
                    Categor√≠a: {{ producto.categoria.nombre|default:"Sin categor√≠a" }}
                </small><br>
                <small>N¬∞ Serie: {{ producto.numero_serie }}</small><br>
                <small>Ubicaci√≥n: {{ producto.ubicacion }}</small><br>
                <small>
                    Proveedor(es):
                    {% if producto.proveedores.all %}
                        {% for prov in producto.proveedores.all %}
                            {{ prov.nombre }}{% if not forloop.last %}, {% endif %}
                        {% empty %}
                            No asignado
                        {% endfor %}
                    {% else %}
                        No asignado
                    {% endif %}
                </small><br>
                <small>
                    <strong>Precio actual:</strong>
                    {% if producto.precio_actual %}
                        ${{ producto.precio_actual }}
                    {% else %}
                        Sin precio asignado
                    {% endif %}
                </small><br>
                <small>
                    Stock:
                    {% if producto.stock <= producto.stock_minimo %}
                        <span class="stock-alerta">
                            {{ producto.stock }} ‚ö†Ô∏è
                            <span class="stock-minimo">(M√≠nimo: {{ producto.stock_minimo }})</span>
                        </span>
                    {% else %}
                        <span class="stock-ok">
                            {{ producto.stock }}
                            <span class="stock-minimo">(M√≠nimo: {{ producto.stock_minimo }})</span>
                        </span>
                    {% endif %}
                </small>
                <br>
                <!-- Bot√≥n historial -->
                <button type="button"
                    onclick="toggleHistorial('historial-{{ producto.pk }}', this)"
                    style="margin-top:8px; margin-bottom:4px; background:#1976d2; color:#fff; border:none; border-radius:4px; padding:3px 10px; cursor:pointer;">
                    Ver historial de precios
                </button>
                <div id="historial-{{ producto.pk }}" style="display:none; margin-bottom:10px;">
                    <strong>Historial de precios:</strong>
                    <ul style="margin-top: 0; margin-bottom: 7px;">
                        {% for h in producto.historial_precios.all %}
                            <li>${{ h.precio }} ({{ h.fecha|date:"d/m/Y" }})</li>
                        {% empty %}
                            <li>Sin historial de precios.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        {% empty %}
        <p>No hay productos registrados.</p>
        {% endfor %}

        <!-- Botones inferiores -->
        <div style="margin-top:18px;">
            <a href="{% url 'registrar_movimiento' %}" style="margin-right:18px;">Registrar Entrada/Salida</a>
            <a href="{% url 'historial_movimientos' %}" style="margin-right:18px;">Ver Historial de Movimientos</a>
            <a href="{% url 'agregar_producto' %}" style="background:#1976d2; color:#fff; padding:6px 16px; border-radius:4px; text-decoration:none;">+ Agregar Producto</a>
            <a href="{% url 'lista_proveedores' %}" style="margin-left:20px;">Gestionar Proveedores</a>
        </div>

    </div>
    <script>
        function toggleHistorial(id, btn) {
            const div = document.getElementById(id);
            if (div.style.display === "none" || div.style.display === "") {
                div.style.display = "block";
                btn.textContent = "Ocultar historial de precios";
            } else {
                div.style.display = "none";
                btn.textContent = "Ver historial de precios";
            }
        }
    </script>
</body>
</html>
